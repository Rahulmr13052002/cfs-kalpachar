---
title: "Cash Flow Statement"
author: "Shwetha Ragothaman"
format: dashboard
params:
  opg_bal: 24265515
execute:
  warning: false
  message: false
  echo: false
---

```{r}
#| label: load_libraries
#| include: false

library(DBI)
library(RMySQL)
library(stringr)
library(lubridate)
library(tidyr)
library(dplyr)
library(knitr)
library(reactable)
library(readxl)

```

```{r}
#| warning: false
#| include: false
#| label: db_connection

# Connect to MySQL: 
con <- dbConnect(
  RMySQL :: MySQL(),
  user = "shwetha",
  password = "Zukti@2025",
  dbname = "tally_kalpachar",
  host = "49.206.25.216",
  port = 3306
)

mapping <- read_excel("LedgerMapping.xlsx", sheet = "Ledger Mapping")

```

```{r}
#| warning: FALSE
#| label: load_data

daybook <- dbGetQuery(con, 
                      "SELECT *, credit_amount - debit_amount AS net_amount, '2025-26' as FY 
                      FROM vw_daybook_detailed WHERE date >= '2025-04-01'AND
                      voucher_type IN ('Payment_New','Receipt_New','Contra_New') ;")


```


```{r}
week_start_thu <- function(x) { x - ((wday(x, week_start = 1) - 4) %% 7) } 
week_label <- function(x) {
  start <- week_start_thu(x) 
  end <- start + days(6) 
  paste0(format(start, "%d %b"), " – ", format(end, "%d %b"))
} 

df <- daybook %>% 
  mutate( Date = as.Date(date), 
          week_label = week_label(Date)
          )

df <- df %>% left_join(mapping, by = "ledger_name")

# Summarize including CAPEX/OPEX group
pivot_data <- df %>%
  group_by(type, sub_type, week_label) %>%
  summarise(net_amount = sum(net_amount, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = week_label,
    values_from = net_amount,
    values_fill = 0
  ) %>%
  mutate(
    Total = rowSums(across(!c(type, sub_type)), na.rm = TRUE)
  ) %>%
  rename(
    Category = type,
    Name = sub_type
  )

# Total row
total_row <- pivot_data %>%
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>%
  mutate(Category = "Total", Name = "Total")

pivot_data <- bind_rows(pivot_data, total_row)

```

# CFS

```{r}
library(gt)
library(dplyr)
library(readr)
library(scales)
library(lubridate)
library(stringr)

# -----------------------------
# CLEAN DATA
# -----------------------------
pivot_data_clean <- pivot_data %>%
  mutate(
    Category = ifelse(is.na(Category) | Category == "", "Uncategorized", Category)
  ) %>%
  filter(!(Category == "Total" & Name == "Total"))

week_cols <- pivot_data_clean %>%
  select(-Category, -Name) %>%
  colnames()

week_cols <- setdiff(week_cols, "Total")

fy_start_year <- as.integer(substr(unique(daybook$FY)[1], 1, 4))

get_week_start <- function(week_label, fy_start_year) {
  week_label <- str_replace_all(week_label, "–", "-")
  start <- str_trim(str_split_fixed(week_label, "-", 2)[, 1])
  d <- dmy(paste(start, fy_start_year))

  if (!is.na(d) && month(d) %in% 1:3) {
    d <- d %m+% years(1)
  }
  d
}

week_cols <- week_cols[
  order(
    sapply(week_cols, get_week_start, fy_start_year = fy_start_year),
    decreasing = TRUE
  )
]

pivot_data_clean <- pivot_data_clean %>%
  select(Category, Name, all_of(week_cols), Total) %>%
  mutate(across(all_of(week_cols), ~ parse_number(as.character(.x))))

# -----------------------------
# CATEGORY TOTALS
# -----------------------------
category_totals <- pivot_data_clean %>%
  group_by(Category) %>%
  summarise(
    across(all_of(week_cols), sum, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Total = rowSums(across(all_of(week_cols)), na.rm = TRUE),
    Name  = "Category Total"
  ) %>%
  select(Category, Name, all_of(week_cols), Total)

# -----------------------------
# GRAND TOTAL
# -----------------------------
grand_total <- category_totals %>%
  summarise(across(all_of(c(week_cols, "Total")), sum, na.rm = TRUE)) %>%
  mutate(
    Category = "Check Value",
    Name     = "Check Value"
  ) %>%
  select(Category, Name, all_of(week_cols), Total)

final_data <- bind_rows(
  pivot_data_clean,
  category_totals,
  grand_total
)

# -----------------------------
# GT TABLE
# -----------------------------
final_data %>%
  gt(groupname_col = "Category", rowname_col = "Name") %>%

  fmt_number(
    columns  = all_of(c(week_cols, "Total")),
    decimals = 0,
    use_seps = TRUE
  ) %>%

  cols_label(
    Name  = "Particulars",
    Total = "Total"
  ) %>%

  cols_align("center", all_of(c(week_cols, "Total"))) %>%
  cols_align("left", Name) %>%

  tab_header(
    title    = md("**Cash Flow Statement**"),
    subtitle = md("Weekly Cash Movement")
  ) %>%

  # -----------------------------
  # CATEGORY NAME (ROW GROUP HEADER) ✅ FIX
  # -----------------------------
  tab_style(
    style = list(
      cell_fill(color = "#e9f2ff"),
      cell_text(weight = "bold")
    ),
    locations = cells_row_groups()
  ) %>%

  # -----------------------------
  # NORMAL ROW INDENT
  # -----------------------------
  tab_style(
    style = cell_text(indent = px(20)),
    locations = cells_body(
      rows = !Name %in% c("Category Total", "Check Value")
    )
  ) %>%

  # -----------------------------
  # CATEGORY TOTAL (ONLY THIS ROW)
  # -----------------------------
  tab_style(
    style = list(
      cell_fill(color = "#e5e9d9ff"),
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = Name == "Category Total")
  ) %>%

  tab_style(
    style = list(
      cell_fill(color = "#e5e9d9ff"),
      cell_text(weight = "bold")
    ),
    locations = cells_stub(rows = Name == "Category Total")
  ) %>%

  # -----------------------------
  # GRAND TOTAL
  # -----------------------------
  tab_style(
    style = list(
      cell_fill(color = "#d6e4ff"),
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = Name == "Check Value")
  ) %>%

  tab_style(
    style = list(
      cell_fill(color = "#d6e4ff"),
      cell_text(weight = "bold")
    ),
    locations = cells_stub(rows = Name == "Check Value")
  ) %>%

  tab_options(
    table.width      = pct(100),
    table.font.size  = px(12),
    data_row.padding = px(5)
  )



```
<!-- 
# CFS 2

```{r}
library(reactable)
library(dplyr)
library(scales)
library(htmltools)
library(htmlwidgets)
library(stringr)
library(lubridate)

pivot_data_clean <- pivot_data %>%
  mutate(
    Category = ifelse(is.na(Category) | Category == "", "Uncategorized", Category)
  ) %>%
  filter(!(Category == "Total" & Name == "Total"))

week_cols <- setdiff(
  colnames(pivot_data_clean),
  c("Category", "Name", "Total")
)

fy_start_year <- as.numeric(substr(unique(pivot_data$FY)[1], 1, 4))

get_week_start_date <- function(labels) {

  labels <- str_replace_all(labels, "–", "-")

  start_days <- str_trim(str_split(labels, "-", simplify = TRUE)[, 1])

  dates <- suppressWarnings(
    as.Date(
      paste(start_days, fy_start_year),
      format = "%d %b %Y"
    )
  )

  dates <- ifelse(
    !is.na(dates) & month(dates) < 4,
    dates %m+% years(1),
    dates
  )

  as.Date(dates, origin = "1970-01-01")
}

week_order <- get_week_start_date(week_cols)

week_cols <- week_cols[order(week_order, decreasing = TRUE)]

pivot_data_clean <- pivot_data_clean %>%
  select(Category, Name, all_of(week_cols), Total)

pivot_data_clean <- pivot_data_clean %>%
  mutate(across(all_of(week_cols), ~ as.numeric(replace_na(.x, 0))))

category_totals <- pivot_data_clean %>%
  group_by(Category) %>%
  summarise(
    across(all_of(week_cols), sum, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Total = rowSums(across(all_of(week_cols)), na.rm = TRUE),
    Name  = "Category Total"
  ) %>%
  select(Category, Name, all_of(week_cols), Total)

grand_total <- category_totals %>%
  summarise(across(all_of(c(week_cols, "Total")), sum, na.rm = TRUE)) %>%
  mutate(
    Category = "Check Value",
    Name     = "Check Value"
  ) %>%
  select(Category, Name, all_of(week_cols), Total)

final_data <- bind_rows(
  pivot_data_clean,
  category_totals,
  grand_total
)

reactable(
  final_data,
  groupBy = "Category",
  bordered = TRUE,
  highlight = TRUE,

  defaultColDef = colDef(
    align = "center",
    headerStyle = list(fontWeight = "bold")
  ),

  columns = c(
    list(
      Name = colDef(
        name = "Particulars",
        align = "left",
        cell = function(value) {
          if (!is.na(value) && value %in% c("Category Total", "Check Value")) {
            tags$b(value)
          } else {
            tags$div(style = "padding-left:16px;", value)
          }
        }
      )
    ),

    lapply(
      setNames(week_cols, week_cols),
      function(col)
        colDef(
          format = colFormat(
            separators = TRUE,
            digits = 0
          )
        )
    ),

    list(
      Total = colDef(
        format = colFormat(separators = TRUE, digits = 0)
      )
    )
  ),

  rowStyle = function(index) {
    row <- final_data[index, , drop = FALSE]

    if (is.na(row$Name)) return(NULL)

    if (row$Name == "Category Total") {
      list(background = "#f3f6e9", fontWeight = "bold")
    } else if (row$Name == "Check Value") {
      list(background = "#e9f2ff", fontWeight = "bold")
    } else {
      NULL
    }
  },

  theme = reactableTheme(
    style = list(fontSize = "12px"),
    headerStyle = list(backgroundColor = "#f7f7f7"),
    groupHeaderStyle = list(backgroundColor = "#eef6ff")
  )
)




``` -->